# Production-ready Docker Compose with build configuration
# Use with: docker-compose -f docker-compose.build.yml up -d --build

services:
  # Backend API
  api:
    build:
      context: ./backend
      dockerfile: Dockerfile.prod
    container_name: qr-api-prod
    restart: unless-stopped
    environment:
      TZ: ${TZ:-America/Santiago}
      # Database Configuration
      MYSQL_HOST: ${MYSQL_HOST}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_DB: ${MYSQL_DB}
      MYSQL_PORT: ${MYSQL_PORT:-3306}

      # Server Configuration
      PORT: ${API_PORT:-3002}
      NODE_ENV: ${NODE_ENV:-production}

      # Security
      API_SECRET: ${API_SECRET}
      CORS_ORIGINS: ${CORS_ORIGINS}
    ports:
      - "{API_PORT:-3002}:${API_PORT:-3002}"
    networks:
      - qr-network
      - newt-proxy
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "${API_HEALTHCHECK_URL:-https://api.lector.lab.informaticauaint.com/health}", "||", "exit", "1"]
      timeout: 10s
      retries: 3
      interval: 30s

  # Frontend Web (Next.js)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.prod
    container_name: qr-frontend-prod
    restart: unless-stopped
    depends_on:
      - api
    environment:
      TZ: ${TZ:-America/Santiago}
      NODE_ENV: ${NODE_ENV:-production}
      API_BASE_URL: ${API_BASE_URL}

      # Next.js Internal Configuration
      PORT: ${FRONTEND_PORT:-3020}
      HOSTNAME: "0.0.0.0"
    ports:
      - "${FRONTEND_PORT:-3020}:${FRONTEND_PORT:-3020}"
    networks:
      - qr-network
      - newt-proxy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "${FRONTEND_HEALTHCHECK_URL:-https://lector.lab.informaticauaint.com}", "||", "exit", "1"]
      timeout: 10s
      retries: 3
      interval: 30s
    extra_hosts:
      - "host.docker.internal:host-gateway"

networks:
  qr-network:
    driver: bridge
  newt-proxy:
    external: true
